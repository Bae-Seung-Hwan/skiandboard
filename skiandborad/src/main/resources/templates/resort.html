<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <th:block th:replace="~{fragments/_head :: head}"></th:block>
    <style>
      /* resort.html ì „ìš© ìŠ¤íƒ€ì¼ */
      main { max-width:1080px; margin:0 auto; padding:24px 16px; }
      .hero-img{width:100%;max-height:420px;object-fit:cover;border-radius:16px;margin-bottom:24px}
      .resort-header h1{font-size:2rem;margin:0}
      .resort-header .desc{color:#555;margin-top:8px;line-height:1.7}
      .score-table{width:100%;border-collapse:collapse;margin-top:16px}
      .score-table th,.score-table td{border:1px solid #e5e7eb;padding:8px;text-align:center}
      .price-box,.info-box{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-top:20px}
      .homepage-link{display:inline-block;margin-top:12px;padding:8px 12px;background:#2563eb;color:#fff;border-radius:8px;text-decoration:none}
    </style>
  </head>
<body>
<header th:replace="~{fragments/_nav :: nav}"></header>
<div class="divider"></div>

<main>
  <!-- âœ… context path í¬í•¨ë˜ë„ë¡ @{} ì¨ì£¼ëŠ”ê²Œ ì•ˆì „ -->
  <img class="hero-img"
       th:if="${resort.heroImageUrl != null}"
       th:src="@{${resort.heroImageUrl}}"
       alt="ìŠ¤í‚¤ì¥ ì´ë¯¸ì§€"/>

  <section class="resort-header">
    <h1 th:text="${resort.name}">ë¦¬ì¡°íŠ¸ëª…</h1>

    <!-- ìŠ¤í‚¤ì¥ ë‚ ì”¨ -->
    <section class="panel" th:if="${resort != null}">
      <h3>ìŠ¤í‚¤ì¥ ë‚ ì”¨</h3>
      <div id="weather">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </section>

    <!-- ë‚ ì”¨ JS -->
    <script th:src="@{/js/weather.js}"></script>

    <!-- resort.id ì „ë‹¬í•´ì„œ í˜¸ì¶œ -->
    <script th:inline="javascript" th:if="${resort != null}">
      const resortId = /*[[${resort.id}]]*/ 0;
      loadWeather(resortId);   // í•œ ê°œ ì¸ìë§Œ!
    </script>

    <p class="desc" th:text="${resort.longDescription}">ìŠ¤í‚¤ì¥ ì„¤ëª…</p>

    <a th:if="${resort.homepageUrl != null}" class="homepage-link"
       th:href="${resort.homepageUrl}" target="_blank" rel="noopener">
      ê³µì‹ í™ˆí˜ì´ì§€ ë°”ë¡œê°€ê¸°
    </a>
  </section>

  <section class="price-box">
    <h3>ğŸŸï¸ ì´ìš© ìš”ê¸ˆ</h3>
    <p th:text="${resort.priceInfo}">ì„±ì¸ 1ì¼ê¶Œ 89,000ì› / ì†Œì¸ 65,000ì›</p>
  </section>

  <section class="info-box">
    <h3>ğŸ“Š ê°ê´€ì  ìŠ¤í‚¤ì¥ í‰ê°€</h3>
    <table class="score-table">
      <tr><th>í•­ëª©</th><th>ì ìˆ˜</th></tr>
      <tr><td>ì´í‰</td><td th:text="${resort.overallRating}">4.5</td></tr>
      <tr><td>ì‹œì„¤</td><td th:text="${resort.facilityScore}">4.6</td></tr>
      <tr><td>ìŠ¬ë¡œí”„</td><td th:text="${resort.slopeScore}">4.7</td></tr>
      <tr><td>ì ‘ê·¼ì„±</td><td th:text="${resort.accessibilityScore}">4.3</td></tr>
      <tr><td>ì„¤ì§ˆ</td><td th:text="${resort.snowQualityScore}">4.8</td></tr>
    </table>
  </section>

  <!-- ğŸ†• ì—¬ê¸°ë¶€í„°: ìµœê·¼ êµí†µ í˜¼ì¡ë„ / ì†ë„ ì°¨íŠ¸ -->
  <section class="panel" th:if="${resort != null}">
    <h3>ìµœê·¼ êµí†µ í˜¼ì¡ë„ / ì†ë„</h3>
    <p class="sub">ìµœê·¼ 24ì‹œê°„ ê¸°ì¤€</p>
    <canvas id="trafficChart" height="120"></canvas>
  </section>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- í˜¼ì¡ë„ / ì†ë„ ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ -->
  <script th:inline="javascript" th:if="${resort != null}">
  /*<![CDATA[*/
    // ìœ„ì˜ weather ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì´ë¯¸ const resortId ì„ ì–¸ë˜ì–´ ìˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    // ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œ(/skiandboard)ë¥¼ í¬í•¨í•œ API prefix
    const trafficApiBase = /*[[@{/api/resorts/}]]*/ "";

    // HH:mm í¬ë§·ìœ¼ë¡œ ë³€í™˜
    function formatTimeLabel(isoString) {
      const d = new Date(isoString);
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    fetch(`${trafficApiBase}${resortId}/traffic-history?hours=24`)
      .then(res => res.json())
      .then(points => {
        if (!points || points.length === 0) return;

        const labels = points.map(p => formatTimeLabel(p.recordedAt));
        const congestion = points.map(p => p.congestionLevel);
        const speeds = points.map(p => p.speed); // null ê·¸ëŒ€ë¡œ ë‘ë©´ Chart.jsê°€ ë¼ì¸ ëŠì–´ì„œ í‘œì‹œ

        const ctx = document.getElementById("trafficChart").getContext("2d");

        new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "í˜¼ì¡ë„(ë ˆë²¨)",
                data: congestion,
                yAxisID: "yLevel",
                tension: 0.3
              },
              {
                label: "í‰ê·  ì†ë„(km/h)",
                data: speeds,
                yAxisID: "ySpeed",
                borderDash: [4, 4],
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: "index", intersect: false },
            scales: {
              yLevel: {
                position: "left",
                min: 1,
                max: 5,
                ticks: {
                  stepSize: 1
                },
                title: { display: true, text: "í˜¼ì¡ë„ ë ˆë²¨" }
              },
              ySpeed: {
                position: "right",
                beginAtZero: true,
                title: { display: true, text: "ì†ë„ (km/h)" }
              }
            },
            plugins: {
              legend: { display: true }
            }
          }
        });
      })
      .catch(err => console.error("traffic chart error", err));
  /*]]>*/
  </script>
  <!-- ğŸ†• ì°¨íŠ¸ ì˜ì—­ ë -->

</main>

<footer class="footer">Â© Ski&Board</footer>
</body>
</html>
