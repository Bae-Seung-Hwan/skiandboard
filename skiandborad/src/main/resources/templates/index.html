<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/_head :: head}"></head>
<body>
<header th:replace="~{fragments/_nav :: nav}"></header>

<div class="divider"></div>

<section class="mast">
  <h1>ì˜¤ëŠ˜ì˜ ìŠ¤í‚¤ì¥</h1>
  <p class="sub">ê°€ê¹Œìš´ ìŠ¤í‚¤ì¥ê³¼ ì¶”ì²œ ì½”ìŠ¤ë¥¼ í•œ ëˆˆì—.</p>
</section>

<section class="map-layout">
  <div id="map" style="height: 800px;"></div>

  <aside class="side">
    <h3>êµ­ë‚´ ìŠ¤í‚¤ì¥</h3>
    <ul id="resortList" class="resort-list">
      <!-- âœ… heroImageUrl ì„ ì´ìš©í•´ ì¸ë„¤ì¼ê¹Œì§€ í‘œì‹œ -->
      <li th:each="r : ${resorts}"
          th:attr="data-id=${r.id}"
          th:attrappend="data-lat=${r.lat},data-lng=${r.lng}">
        <a th:href="@{'/resorts/' + ${r.id}}" class="resort-item">
          <img th:if="${r.heroImageUrl != null}"
               th:src="@{${r.heroImageUrl}}"
               alt="ìŠ¤í‚¤ì¥ ì‚¬ì§„"
               class="resort-thumb"/>

          <div class="resort-body">
            <strong th:text="${r.name}">ë¦¬ì¡°íŠ¸ëª…</strong>
            <div class="desc" th:text="${r.description}">ì„¤ëª…</div>
          </div>
        </a>
      </li>

      <li th:if="${#lists.isEmpty(resorts)}" class="empty">
        ë“±ë¡ëœ ìŠ¤í‚¤ì¥ì´ ì•„ì§ ì—†ì–´ìš”.
      </li>
    </ul>
  </aside>
</section>

<footer class="footer">Â© Ski&Board</footer>

<!-- Leaflet CSS / JS -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<!-- resorts ë¦¬ìŠ¤íŠ¸ë¥¼ JS ê°ì²´ë¡œ ì£¼ì… -->
<script th:inline="javascript">
/*<![CDATA[*/
  const resorts = /*[[${resorts}]]*/ [];
  const ctxPath = /*[[@{/}]]*/ '';   // ì˜ˆ: "/skiandboard/"
/*]]>*/
</script>

<script>
  // ê¸°ë³¸ ì§€ë„ ì„¤ì •
  const map = L.map('map').setView([36.5, 127.8], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  const skiLayer = L.layerGroup().addTo(map);

  // ê¸°ë³¸ ì•„ì´ì½˜ (ì´ë¯¸ì§€ ì—†ëŠ” ê²½ìš° fallback)
  const defaultSkiIcon = L.icon({
    iconUrl: (ctxPath.replace(/\/$/, '')) + '/img/icon-ski.png',
    iconSize: [28, 28],
    iconAnchor: [14, 28],
    popupAnchor: [0, -24]
  });

  // âœ… ìŠ¤í‚¤ì¥ ì‚¬ì§„ì´ ë“¤ì–´ê°„ ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜
  function createResortIcon(imageUrl) {
    return L.divIcon({
      className: 'resort-map-icon',
      html: `
        <div class="resort-map-icon__inner">
          <img src="${imageUrl}" alt="">
        </div>
      `,
      iconSize: [52, 52],
      iconAnchor: [26, 52],
      popupAnchor: [0, -52]
    });
  }


  const markerById = new Map();
  let activeHighlight = null;

  // ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ resortsë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œ
  if (resorts && resorts.length) {
    const bounds = [];

	resorts.forEach(r => {
	  if (!r.lat || !r.lng) return;

	  // âœ… heroImageUrl("/img/...") ì•ì— ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œ ë¶™ì´ê¸°
	  const imageUrl = r.heroImageUrl
	      ? ctxPath.replace(/\/$/, '') + r.heroImageUrl
	      : null;

	  const imageHtml = imageUrl
	    ? `<img src="${imageUrl}"
	             style="width:100%;height:110px;object-fit:cover;border-radius:10px;margin-bottom:8px;">`
	    : '';

	  // âŒ ê¸°ì¡´: í•­ìƒ skiIcon ì‚¬ìš©
	  // const marker = L.marker([r.lat, r.lng], { icon: skiIcon })

	  // âœ… ë³€ê²½: ì‚¬ì§„ì´ ìˆìœ¼ë©´ ì‚¬ì§„ ì•„ì´ì½˜, ì—†ìœ¼ë©´ ê¸°ë³¸ ì•„ì´ì½˜
	  const icon = imageUrl ? createResortIcon(imageUrl) : defaultSkiIcon;

	  const marker = L.marker([r.lat, r.lng], { icon })
	    .addTo(skiLayer)
	    .bindPopup(
	      `<div style="max-width:240px; line-height:1.4;">
	         ${imageHtml}
	         <strong style="font-size:1.1em;">${r.name}</strong><br/>
	         <span style="color:#555;">${r.description ?? ''}</span>
	       </div>`
	    );

	  markerById.set(String(r.id), marker);
	  bounds.push([r.lat, r.lng]);
	});


    if (bounds.length) {
      map.fitBounds(bounds, { padding: [20, 20] });
    }
  }

  // ğŸ¯ ë¦¬ìŠ¤íŠ¸ hover ì´ë²¤íŠ¸
  const listEl = document.getElementById('resortList');

  listEl?.addEventListener('mouseover', e => {
    const li = e.target.closest('li[data-id]');
    if (!li) return;

    const id = li.dataset.id;
    const marker = markerById.get(String(id));
    if (!marker) return;

    const pos = marker.getLatLng();

    if (activeHighlight) {
      map.removeLayer(activeHighlight);
      activeHighlight = null;
    }

    map.flyTo(pos, 11, { animate: true, duration: 0.6 });
    marker.openPopup();

    activeHighlight = L.circle(pos, {
      radius: 800,
      color: '#2563eb',
      weight: 2,
      fillOpacity: 0.15
    }).addTo(map);

    li.classList.add('is-hover');
  });

  listEl?.addEventListener('mouseout', e => {
    const li = e.target.closest('li[data-id]');
    if (!li) return;

    if (activeHighlight) {
      map.removeLayer(activeHighlight);
      activeHighlight = null;
    }

    li.classList.remove('is-hover');
  });

  // ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ í•´ë‹¹ ë§ˆì»¤ë¡œ ì¤Œ ì¸ + íŒì—…
  listEl?.addEventListener('click', e => {
    const li = e.target.closest('li[data-id]');
    if (!li) return;

    const id = li.dataset.id;
    const marker = markerById.get(String(id));
    if (!marker) return;

    const pos = marker.getLatLng();
    map.flyTo(pos, 12, { animate: true, duration: 0.6 });
    marker.openPopup();
  });
</script>

<!-- ì´ í˜ì´ì§€ ì „ìš© ê°„ë‹¨ ìŠ¤íƒ€ì¼ -->
<style>
  .resort-list li {
    padding: 8px 10px;
    border-radius: 8px;
    transition: background 0.2s ease;
  }

  .resort-list li.is-hover {
    background: #f3f4f6;
  }

  .resort-list a.resort-item {
    color: inherit;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .resort-thumb {
    width: 72px;
    height: 72px;
    object-fit: cover;
    border-radius: 8px;
    flex-shrink: 0;
  }

  .resort-body {
    display: flex;
    flex-direction: column;
  }

  .resort-list .empty {
    color: #9ca3af;
    font-size: 0.9rem;
  }
  /* ì§€ë„ ìœ„ ì‚¬ì§„ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
  .resort-map-icon {
    background: transparent;
    border: none;
  }

  .resort-map-icon__inner {
    width: 48px;
    height: 48px;
    border-radius: 999px;
    overflow: hidden;
    box-shadow:
      0 0 0 2px #ffffff,
      0 10px 18px rgba(15, 23, 42, 0.35);
  }

  .resort-map-icon__inner img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

</style>
</body>
</html>

